<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart</title>
    <link rel="stylesheet" href="../css/cart.css">
</head>
<body>

    <div class="container">
        <div class="cart">
            <h2>Your Cart</h2>
            <% if (cart.length > 0) { %>
                <p class="item-count">You have <%= cart.length %> item(s) in your cart.</p>
                <% cart.forEach(item => { %>
                    <div class="cart-item" data-id="<%= item.camera_id %>">
                        <img src="../image/<%= item.cameraimg %>" alt="<%= item.cameraname %>">
                            <div class="item-details">
                                <p class="item-name"><%= item.cameraname %></p>
                                <label>Return Date:</label>
                                <input type="date" class="return-date" data-id="<%= item.camera_id %>" min="<%= new Date().toISOString().split('T')[0] %>">
                            </div>
                            <p class="price" data-price="<%= item.price_per_day %>"><%= item.price_per_day %> บาท</p>

                            <form action="/removeFromCart" method="POST">
                                <input type="hidden" name="camera_id" value="<%= item.camera_id %>">
                                <button type="submit" class="remove-btn">Remove</button>
                            </form>
     
                    </div>
                <% }); %>
                <a href="/" class="back">Continue Shopping</a>
            <% } else { %>
                <p>Your cart is empty.</p>
            <% } %>
            <div class="summary">
                <h2>Summary</h2>
                <div class="summary-item">
                    <span>Total:</span>
                    <span class="total"><%= totalPrice %> บาท</span>
                </div>
                <!-- ฟอร์ม Checkout -->
                <form action="/order" method="POST" id="checkout-form">
                    <input type="hidden" name="end_date" id="end-date-input">  <!-- input hidden สำหรับส่งข้อมูล end_date -->
                    <button type="submit" class="checkout">Proceed to Checkout</button>
                </form>
                         
                
            </div>
            
        </div>
    </div>

    <script>
        // เมื่อผู้ใช้กด "Proceed to Checkout"
    document.querySelector('.checkout').addEventListener('click', function() {
        const endDateInput = document.querySelector('.return-date');  // เลือก input ของ return date
        
        if (endDateInput && endDateInput.value) {
            const endDate = endDateInput.value;  // รับค่าจาก input return-date
            document.querySelector('#end-date-input').value = endDate;  // ตั้งค่า end_date ใน hidden input
        } else {
            alert('Please select a return date.');
        }
    });
    document.querySelectorAll('.remove-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault(); // ป้องกันไม่ให้ฟอร์มถูกส่ง
            const cameraId = this.getAttribute('data-id'); // ดึง id ของกล้องจาก data-id
            const form = document.querySelector(`#form-${cameraId}`); // เลือกฟอร์มที่เกี่ยวข้อง
            form.submit(); // ส่งฟอร์มไปที่เซิร์ฟเวอร์เพื่อทำการลบ
        });
    });


    document.querySelectorAll('.return-date').forEach(input => {
        input.addEventListener('change', function() {
            const itemId = this.getAttribute('data-id');
            const selectedDate = new Date(this.value);
            const today = new Date();
            const days = Math.max(1, Math.ceil((selectedDate - today) / (1000 * 60 * 60 * 24)));

            
            const form = document.querySelector(`#form-${itemId}`);
            const endDateInput = form.querySelector('.end-date');
            endDateInput.value = selectedDate.toISOString().split('T')[0]; 

            updateTotalPrice(itemId, days); 
        });
    });

    function updateTotalPrice() {
        let total = 0;
        document.querySelectorAll('.cart-item').forEach(item => {
            const price = parseFloat(item.querySelector('.price').innerText.replace(' บาท', ''));
            const quantity = parseInt(item.querySelector('.quantity-input').value);
            total += price * quantity;
        });
            
        document.querySelector('.total').innerText = total + ' บาท';
        }
    
        // Function to update cart quantity in the backend
        function updateCartQuantity(input) {
            const camera_id = input.closest('.cart-item').querySelector('input[name="camera_id"]').value;
            const quantity = input.value;
    
            // Send updated quantity to the backend using fetch
            fetch('/updateCart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ camera_id, quantity })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Cart updated:', data);
            })
            .catch((error) => {
                console.error('Error updating cart:', error);
            });
        }
        document.querySelectorAll('.remove-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault(); // ป้องกันไม่ให้ฟอร์มถูกส่ง
            const cameraId = this.closest('form').querySelector('input[name="camera_id"]').value;
            
            fetch('/removeFromCart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ camera_id: cameraId })
            })
            .then(response => response.json())
            .then(data => {
                // อัปเดต UI หรือแสดงข้อความหลังจากลบสำเร็จ
                console.log(data);
                this.closest('.cart-item').remove();  // ลบไอเทมจาก UI
            })
            .catch(error => {
                console.error('Error removing item:', error);
            });
        });
    });
    </script>
</body>
</html>